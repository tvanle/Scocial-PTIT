generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== AUTH & USER ==============

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  studentId       String?   @unique

  // Profile
  fullName        String?
  avatar          String?
  coverImage      String?
  bio             String?
  dateOfBirth     DateTime?
  gender          Gender?
  phone           String?

  // Status
  isVerified      Boolean   @default(false)
  isEmailVerified Boolean   @default(false)
  isActive        Boolean   @default(true)
  lastActiveAt    DateTime?

  // Two-Factor Authentication
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  posts           Post[]
  comments        Comment[]
  likes           Like[]

  // Follow system
  followers       Follow[]  @relation("Following")
  following       Follow[]  @relation("Followers")

  // Notifications
  sentNotifications     Notification[] @relation("NotificationSender")
  receivedNotifications Notification[] @relation("NotificationReceiver")

  // Refresh tokens
  refreshTokens   RefreshToken[]

  // Verification codes
  verificationCodes VerificationCode[]

  // Chat relations
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]                 @relation("MessageSender")
  messageReadStatuses      MessageReadStatus[]       @relation("MessageReadBy")

  @@index([email])
  @@index([studentId])
}

model VerificationCode {
  id          String             @id @default(uuid())
  code        String
  type        VerificationCodeType
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  isUsed      Boolean            @default(false)
  createdAt   DateTime           @default(now())

  @@index([userId, type])
  @@index([code, type])
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============== POST ==============

model Post {
  id          String      @id @default(uuid())
  content     String?
  authorId    String
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Privacy
  privacy     PostPrivacy @default(PUBLIC)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  media       Media[]
  comments    Comment[]
  likes       Like[]

  @@index([authorId])
  @@index([createdAt])
}

model Comment {
  id          String    @id @default(uuid())
  content     String
  authorId    String
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  postId      String
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Reply
  parentId    String?
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

// ============== MEDIA ==============

model Media {
  id          String    @id @default(uuid())
  url         String
  type        MediaType
  filename    String
  mimeType    String
  size        Int
  width       Int?
  height      Int?
  duration    Int?      // For video/audio

  postId      String?
  post        Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@index([postId])
}


// ============== NOTIFICATION ==============

model Notification {
  id          String           @id @default(uuid())
  type        NotificationType
  content     String?
  isRead      Boolean          @default(false)

  senderId    String?
  sender      User?            @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId  String
  receiver    User             @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  // Reference
  referenceId String?          // postId, commentId, groupId, etc.

  createdAt   DateTime         @default(now())

  @@index([receiverId])
  @@index([senderId])
  @@index([createdAt])
}

// ============== ENUMS ==============

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PostPrivacy {
  PUBLIC
  FOLLOWERS
  PRIVATE
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}


enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
  SYSTEM
}

// ============== CHAT ==============

model Conversation {
  id            String            @id @default(uuid())
  type          ConversationType  @default(PRIVATE)
  name          String?
  avatar        String?

  // Denormalized lastMessage for performance
  lastMessageContent   String?
  lastMessageSenderId  String?
  lastMessageCreatedAt DateTime?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  participants  ConversationParticipant[]
  messages      Message[]

  @@index([updatedAt(sort: Desc)])
}

model ConversationParticipant {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt        DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId        String
  sender          User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  content         String
  type            MessageType  @default(TEXT)
  mediaUrl        String?
  isRead          Boolean      @default(false)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  readBy          MessageReadStatus[]

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
}

model MessageReadStatus {
  id         String   @id @default(uuid())
  messageId  String
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("MessageReadBy", fields: [userId], references: [id], onDelete: Cascade)
  readAt     DateTime @default(now())

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
}

enum ConversationType {
  PRIVATE
  GROUP
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  FILE
}

enum VerificationCodeType {
  EMAIL_VERIFY
  PASSWORD_RESET
  TWO_FACTOR
}
